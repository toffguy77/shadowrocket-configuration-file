name: Validate rules and produce deduped list

on:
  workflow_dispatch:
  push:
    paths:
      - 'rules/private.list'
      - 'rules/private.direct.list'
      - 'rules/**'
      - 'ru_config-private.conf'
  pull_request:
    paths:
      - 'rules/private.list'
      - 'rules/private.direct.list'
      - 'rules/**'
      - 'ru_config-private.conf'

permissions:
  contents: write

jobs:
  validate-and-dedup:
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Run rules validator
        run: |
          python3 scripts/validate_rules.py rules/private.list --check-urls
          python3 scripts/validate_rules.py rules/private.direct.list --check-urls

      - name: Run config validator
        run: |
          python3 scripts/validate_config.py ru_config-private.conf

      - name: Produce deduped lists
        run: |
          python3 scripts/dedup_rules.py rules/private.list rules/private.dedup.list
          python3 scripts/dedup_rules.py rules/private.direct.list rules/private.dedup-direct.list

      - name: Validate deduped lists
        run: |
          python3 scripts/validate_rules.py rules/private.dedup.list --check-urls
          python3 scripts/validate_rules.py rules/private.dedup-direct.list --check-urls

      - name: Rewrite ru_config-private.conf RULE-SETs to dedup (in-place)
        env:
          DEDUP_RAW_PROXY: "https://raw.githubusercontent.com/${{ env.REPO }}/${{ env.BRANCH_NAME }}/rules/private.dedup.list"
          DEDUP_RAW_DIRECT: "https://raw.githubusercontent.com/${{ env.REPO }}/${{ env.BRANCH_NAME }}/rules/private.dedup-direct.list"
        run: |
          set -euo pipefail
          echo "Rewriting ru_config-private.conf to dedup URLs"
          # Replace PROXY private list to dedup
          perl -0777 -pe 'BEGIN{$d=$ENV{"DEDUP_RAW_PROXY"}} s{RULE-SET,\s*https?://[^,]*private(?:\.dedup)?\.list\s*,}{"RULE-SET,$d,"}ig' ru_config-private.conf > /tmp/ru_config.tmp
          mv /tmp/ru_config.tmp ru_config-private.conf
          # Replace DIRECT private direct list to dedup-direct (dot or dash between private and direct)
          perl -0777 -pe 'BEGIN{$d=$ENV{"DEDUP_RAW_DIRECT"}} s{RULE-SET,\s*https?://[^,]*private(?:\.dedup)?(?:[\.-])direct\.list\s*,}{"RULE-SET,$d,"}ig' ru_config-private.conf > /tmp/ru_config.tmp
          mv /tmp/ru_config.tmp ru_config-private.conf

      - name: Check for changes
        id: git-check
        run: |
          CHANGED=$(git status --porcelain | wc -l | tr -d '[:space:]')
          if [ "$CHANGED" != "0" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit dedup outputs and ru_config (if changed)
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ru_config-private.conf rules/private.dedup.list rules/private.dedup-direct.list || true
          if git commit -m "ci: update rules/private.* dedup files and ru_config-private.conf [skip ci]"; then
            git push origin HEAD:${{ github.ref_name }}
          else
            echo 'Nothing to commit'
          fi
