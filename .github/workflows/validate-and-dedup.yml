name: Validate rules and produce deduped list

on:
  workflow_dispatch:
  push:
    paths:
      - 'rules/private.list'
      - 'rules/private-direct.list'
      - 'rules/**'
      - 'ru_config-private.conf'
  pull_request:
    paths:
      - 'rules/private.list'
      - 'rules/private-direct.list'
      - 'rules/**'
      - 'ru_config-private.conf'

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-and-dedup:
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mark workspace safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Run rules validator
        run: |
          # #region agent log
          echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:52\",\"message\":\"Starting rules validation\",\"data\":{\"hypothesisId\":\"A\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:52\",\"message\":\"Starting rules validation\",\"data\":{\"hypothesisId\":\"A\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> .cursor/debug.log 2>/dev/null || true
          # #endregion
          if [ ! -f rules/private.list ]; then
            echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:52\",\"message\":\"ERROR: rules/private.list missing\",\"data\":{\"hypothesisId\":\"D\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:52\",\"message\":\"ERROR: rules/private.list missing\",\"data\":{\"hypothesisId\":\"D\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> .cursor/debug.log 2>/dev/null || true
            exit 1
          fi
          if [ ! -f rules/private-direct.list ]; then
            echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:52\",\"message\":\"ERROR: rules/private-direct.list missing\",\"data\":{\"hypothesisId\":\"D\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:52\",\"message\":\"ERROR: rules/private-direct.list missing\",\"data\":{\"hypothesisId\":\"D\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> .cursor/debug.log 2>/dev/null || true
            exit 1
          fi
          python3 scripts/validate_rules.py rules/private.list --check-urls || VALIDATION_EXIT=$?
          if [ "${VALIDATION_EXIT:-0}" != "0" ]; then
            echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:52\",\"message\":\"URL validation failed for private.list\",\"data\":{\"hypothesisId\":\"A\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"exitCode\":\"${VALIDATION_EXIT}\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:52\",\"message\":\"URL validation failed for private.list\",\"data\":{\"hypothesisId\":\"A\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"exitCode\":\"${VALIDATION_EXIT}\"}}" >> .cursor/debug.log 2>/dev/null || true
            exit ${VALIDATION_EXIT}
          fi
          python3 scripts/validate_rules.py rules/private-direct.list --check-urls || VALIDATION_EXIT=$?
          if [ "${VALIDATION_EXIT:-0}" != "0" ]; then
            echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:52\",\"message\":\"URL validation failed for private-direct.list\",\"data\":{\"hypothesisId\":\"A\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"exitCode\":\"${VALIDATION_EXIT}\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:52\",\"message\":\"URL validation failed for private-direct.list\",\"data\":{\"hypothesisId\":\"A\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"exitCode\":\"${VALIDATION_EXIT}\"}}" >> .cursor/debug.log 2>/dev/null || true
            exit ${VALIDATION_EXIT}
          fi

      - name: Run config validator
        run: |
          python3 scripts/validate_config.py ru_config-private.conf

      - name: Produce deduped lists
        run: |
          python3 scripts/dedup_rules.py rules/private.list rules/private.dedup.list
          python3 scripts/dedup_rules.py rules/private-direct.list rules/private.dedup-direct.list

      - name: Validate deduped lists
        run: |
          python3 scripts/validate_rules.py rules/private.dedup.list --check-urls || VALIDATION_EXIT=$?
          if [ "${VALIDATION_EXIT:-0}" != "0" ]; then
            echo "ERROR: Validation of private.dedup.list failed with exit code ${VALIDATION_EXIT}"
            exit ${VALIDATION_EXIT}
          fi
          python3 scripts/validate_rules.py rules/private.dedup-direct.list --check-urls || VALIDATION_EXIT=$?
          if [ "${VALIDATION_EXIT:-0}" != "0" ]; then
            echo "ERROR: Validation of private.dedup-direct.list failed with exit code ${VALIDATION_EXIT}"
            exit ${VALIDATION_EXIT}
          fi

      - name: Rewrite ru_config-private.conf RULE-SETs to dedup (in-place)
        env:
          DEDUP_RAW_PROXY: "https://raw.githubusercontent.com/${{ env.REPO }}/${{ env.BRANCH_NAME }}/rules/private.dedup.list"
          DEDUP_RAW_DIRECT: "https://raw.githubusercontent.com/${{ env.REPO }}/${{ env.BRANCH_NAME }}/rules/private.dedup-direct.list"
        run: |
          set -euo pipefail
          # #region agent log
          echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:69\",\"message\":\"Starting RULE-SET rewrite\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"dedupProxy\":\"$DEDUP_RAW_PROXY\",\"dedupDirect\":\"$DEDUP_RAW_DIRECT\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:69\",\"message\":\"Starting RULE-SET rewrite\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"dedupProxy\":\"$DEDUP_RAW_PROXY\",\"dedupDirect\":\"$DEDUP_RAW_DIRECT\"}}" >> .cursor/debug.log 2>/dev/null || true
          # #endregion
          echo "Rewriting ru_config-private.conf to dedup URLs"
          # Backup original
          cp ru_config-private.conf ru_config-private.conf.bak
          # Replace PROXY private list to dedup
          perl -0777 -pe 'BEGIN{$d=$ENV{"DEDUP_RAW_PROXY"}} s{RULE-SET,\s*https?://[^,]*private(?:\.dedup)?\.list\s*,}{RULE-SET,$d,}ig' ru_config-private.conf > /tmp/ru_config.tmp
          # #region agent log
          echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:77\",\"message\":\"After PROXY replacement\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:77\",\"message\":\"After PROXY replacement\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> .cursor/debug.log 2>/dev/null || true
          grep -n "RULE-SET.*private" /tmp/ru_config.tmp | head -2 | while IFS=: read line_num content; do echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:77\",\"message\":\"RULE-SET line after PROXY replace\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"lineNum\":\"$line_num\",\"content\":\"$content\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:77\",\"message\":\"RULE-SET line after PROXY replace\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"lineNum\":\"$line_num\",\"content\":\"$content\"}}" >> .cursor/debug.log 2>/dev/null || true; done
          # #endregion
          mv /tmp/ru_config.tmp ru_config-private.conf
          # Replace DIRECT private direct list to dedup-direct (dot or dash between private and direct)
          perl -0777 -pe 'BEGIN{$d=$ENV{"DEDUP_RAW_DIRECT"}} s{RULE-SET,\s*https?://[^,]*private(?:\.dedup)?(?:[\.-])direct\.list\s*,}{RULE-SET,$d,}ig' ru_config-private.conf > /tmp/ru_config.tmp
          # #region agent log
          echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:80\",\"message\":\"After DIRECT replacement\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:80\",\"message\":\"After DIRECT replacement\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> .cursor/debug.log 2>/dev/null || true
          grep -n "RULE-SET.*private" /tmp/ru_config.tmp | head -2 | while IFS=: read line_num content; do echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:80\",\"message\":\"RULE-SET line after DIRECT replace\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"lineNum\":\"$line_num\",\"content\":\"$content\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:80\",\"message\":\"RULE-SET line after DIRECT replace\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"lineNum\":\"$line_num\",\"content\":\"$content\"}}" >> .cursor/debug.log 2>/dev/null || true; done
          # #endregion
          mv /tmp/ru_config.tmp ru_config-private.conf
          # Validate the result
          if grep -q '^"RULE-SET' ru_config-private.conf || grep -q 'RULE-SET.*,"' ru_config-private.conf; then
            echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:82\",\"message\":\"ERROR: Malformed RULE-SET detected after replacement\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:82\",\"message\":\"ERROR: Malformed RULE-SET detected after replacement\",\"data\":{\"hypothesisId\":\"B\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> .cursor/debug.log 2>/dev/null || true
            echo "ERROR: Malformed RULE-SET entries detected!"
            grep '^"RULE-SET\|RULE-SET.*,"' ru_config-private.conf || true
            exit 1
          fi
      
      - name: Validate config after RULE-SET rewrite
        run: |
          python3 scripts/validate_config.py ru_config-private.conf || CONFIG_VALIDATION_EXIT=$?
          if [ "${CONFIG_VALIDATION_EXIT:-0}" != "0" ]; then
            echo "ERROR: Config validation failed after RULE-SET rewrite"
            exit ${CONFIG_VALIDATION_EXIT}
          fi

      - name: Check for changes
        id: git-check
        run: |
          CHANGED=$(git status --porcelain | wc -l | tr -d '[:space:]')
          if [ "$CHANGED" != "0" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit dedup outputs and ru_config (if changed)
        if: steps.git-check.outputs.changed == 'true' && github.event_name != 'pull_request'
        run: |
          # #region agent log
          echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:93\",\"message\":\"Starting git commit/push\",\"data\":{\"hypothesisId\":\"C\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:93\",\"message\":\"Starting git commit/push\",\"data\":{\"hypothesisId\":\"C\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> .cursor/debug.log 2>/dev/null || true
          # #endregion
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ru_config-private.conf rules/private.dedup.list rules/private.dedup-direct.list || true
          if git commit -m "ci: update rules/private.* dedup files and ru_config-private.conf [skip ci]"; then
            # #region agent log
            echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:99\",\"message\":\"Commit successful, fetching latest changes\",\"data\":{\"hypothesisId\":\"C\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:99\",\"message\":\"Commit successful, fetching latest changes\",\"data\":{\"hypothesisId\":\"C\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> .cursor/debug.log 2>/dev/null || true
            # #endregion
            # Fetch latest changes before rebase to avoid race conditions with concurrent workflows
            git fetch origin ${{ github.ref_name }}
            git pull --rebase origin ${{ github.ref_name }} || PULL_EXIT=$?
            if [ "${PULL_EXIT:-0}" != "0" ]; then
              echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:100\",\"message\":\"ERROR: git pull --rebase failed\",\"data\":{\"hypothesisId\":\"C\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"exitCode\":\"${PULL_EXIT}\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:100\",\"message\":\"ERROR: git pull --rebase failed\",\"data\":{\"hypothesisId\":\"C\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"exitCode\":\"${PULL_EXIT}\"}}" >> .cursor/debug.log 2>/dev/null || true
              git status || true
              exit ${PULL_EXIT}
            fi
            # #region agent log
            echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:101\",\"message\":\"Pulling successful, pushing\",\"data\":{\"hypothesisId\":\"C\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:101\",\"message\":\"Pulling successful, pushing\",\"data\":{\"hypothesisId\":\"C\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\"}}" >> .cursor/debug.log 2>/dev/null || true
            # #endregion
            git push origin HEAD:${{ github.ref_name }} || PUSH_EXIT=$?
            if [ "${PUSH_EXIT:-0}" != "0" ]; then
              echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:101\",\"message\":\"ERROR: git push failed, retrying with fetch\",\"data\":{\"hypothesisId\":\"C\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"exitCode\":\"${PUSH_EXIT}\"}}" >> "$GITHUB_WORKSPACE/.cursor/debug.log" 2>/dev/null || echo "{\"timestamp\":$(date +%s000),\"location\":\"validate-and-dedup.yml:101\",\"message\":\"ERROR: git push failed, retrying with fetch\",\"data\":{\"hypothesisId\":\"C\",\"runId\":\"debug-run\",\"sessionId\":\"debug-session\",\"exitCode\":\"${PUSH_EXIT}\"}}" >> .cursor/debug.log 2>/dev/null || true
              # Retry: fetch latest and rebase again, then push
              git fetch origin ${{ github.ref_name }}
              git rebase origin/${{ github.ref_name }} || true
              git push origin HEAD:${{ github.ref_name }} || exit ${PUSH_EXIT}
            fi
          else
            echo 'Nothing to commit'
          fi

      - name: Upload dedup artifacts (PR only)
        if: steps.git-check.outputs.changed == 'true' && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: dedup-outputs
          path: |
            rules/private.dedup.list
            rules/private.dedup-direct.list
            ru_config-private.conf
